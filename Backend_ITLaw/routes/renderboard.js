const router = require('express').Router();
let Renderboard = require('../models/Renderboardmodel');
let User = require('../models/UserModel');


router.route('/').get((req, res) => {
    Renderboard.find()
      .then(render => {res.json(render)})
      .catch(err => res.status(400).json('Error: ' + err));
  });


router.route('/add').post( async (req, res) => {
    const name = req.body.name;
    const imageuser = req.body.imageuser;
    const iduser = req.body.iduser;
    const score = req.body.score
    const email = req.body.email
    const datauser1 = req.body.datauser1
    const datauser2 = req.body.datauser2
    const datauser3 = req.body.datauser3
    const datauser4 = req.body.datauser4
    const datauser5 = req.body.datauser5
    const datauser6 = req.body.datauser6


    

    try{ const user = await Renderboard.findOne({
      email :email
    }) 

    if(user == null){
        var datascore = {name: name, imageuser:imageuser, iduser:iduser, score:score,  email:email}
        await Renderboard.create(datascore)
        var status = await User.findOne({email:email})
        if(datauser1 != null){
          await status.updateOne({'question1' : datauser1})
        }if(datauser2 != null){
          await status.updateOne({'question2' : datauser2})
        }if(datauser3 != null){
          await status.updateOne({'question3' : datauser3})
        }if(datauser4 != null){
          await status.updateOne({'question4' : datauser4})
        }if(datauser5 != null){
          await status.updateOne({'question5' : datauser5})
        }if(datauser6 != null){
          await status.updateOne({'question6' : datauser6})
        }
        res.sendStatus(200)
  }else{
      var orgscore = await Renderboard.findOne({email:email})
      var total = orgscore.score + score
      var status = await User.findOne({email:email})
      if(datauser1 != null){
        await status.updateOne({'question1' : datauser1})
      }if(datauser2 != null){
        await status.updateOne({'question2' : datauser2})
      }if(datauser3 != null){
        await status.updateOne({'question3' : datauser3})
      }if(datauser4 != null){
        await status.updateOne({'question4' : datauser4})
      }if(datauser5 != null){
        await status.updateOne({'question5' : datauser5})
      }if(datauser6 != null){
        await status.updateOne({'question6' : datauser6})
      }
     
      console.log('total  =', orgscore.score, "+", score)
      await orgscore.updateOne({'iduser' : iduser, 'score' : total})
      .then(() => {console.log('update complete'); res.sendStatus(200)})
    }
  }catch(err){
    res.status(500).json(err.message)
  }
  
})

module.exports = router;
