const router = require('express').Router();
const { json } = require('express');
let User = require('../models/UserModel');

router.route('/').get((req, res) => {
  User.find()
    .then(users => {res.json(users)})
    .catch(err => res.status(400).json('Error: ' + err));
});

router.route('/getdatauser').post(async (req, res) => {
  const iduser = req.body.iduser
  try{
    const data = await User.findOne({'iduser': iduser})
    var question = []
    var numberquestion = 1
    var dataanswer = []
    if(data){
      for (let index = 0; index < data.history.length; index++) {
        question.push(data.history[index].questionname)
      }
      question = question.sort()

      for (let index = 0; index < question.length; index++) {
        if(question[index] == question[index+1] && question[index+1] != undefined){
          numberquestion = numberquestion + 1
        }else{
          var numberans = {
            'namequestion' : question[index],
            'count' :  numberquestion,
          }
          dataanswer.push(numberans)
          numberquestion = 1
        }
        
      }
      
      res.status(200).json({'name' : data.name, 'iamgeuser': data.imageuser, 'API_Hacking':dataanswer[0],'Admin_Note':dataanswer[1],'Cookies_Attack':dataanswer[2],'Token_Is':dataanswer[3], dataanswer})
    }else{
      console.log('er')
      res.sendStatus(500)
    }

  }catch(er){
    console.log('errrr', er.message)
    res.sendStatus(500)

  }

  
  
});



router.route('/add').post( async (req, res) => {
  const name = req.body.name;
  const imageuser = req.body.imageuser;
  const iduser = req.body.iduser
  const email = req.body.email
  const question1 = false
  const question2 = false
  const question3 = false
  const question4 = false
  const question5 = false
  const question6 = false


 try{ const user = await User.findOne({
    email :email
  }) 

  if(!user){
    var data = {name: name, imageuser:imageuser, iduser:iduser, email:email, question1:question1,
      question2:question2,
      question3:question3,
      question4:question4,
      question5:question5,
      question6:question6
    
    }
      await User.create(data)
      res.sendStatus(200)
}else{
    await User.updateOne(
      {$set :{'iduser' : iduser}}
    )
    .then(() => {console.log('update complete'); res.sendStatus(200)})
    // .catch(() => console.log('error'))
  }
}catch(err){
  res.status(500).json({err})
}
});

router.route('/setstatus').post(async (req, res) => {
  const email = req.body.email
  const question1 = req.body.question1
  var questionuser = await User.findOne({email:email})
  await questionuser.updateOne({'question1': question1})
  .then((res) => res.sendStatus(200))
  .catch((er) => res.json(er))

});




module.exports = router;
